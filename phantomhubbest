-- // PHANTOM HUB | AI \\ --
-- Updated: Draggable GUI & Flat Ground Circle

local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

repeat task.wait() until game:IsLoaded()

-- // HTTP REQUEST COMPATIBILITY \\ --
local HttpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or (solara and solara.request) or request
if not HttpRequest then
	game:GetService("StarterGui"):SetCore("SendNotification", {
		Title = "Missing Executor",
		Text = "Your executor does not support http_request.",
		Duration = 5
	})
	return
end

-- // CONFIGURATION \\ --
local LP = Players.LocalPlayer
local Character = LP.Character or LP.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- KEY
local API_KEY = "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"

local BASE_URL = "https://openrouter.ai/api/v1/chat/completions"
local AI_MODEL = "openai/gpt-4o" 
local SITE_URL = "https://roblox.com"
local SITE_NAME = "Phantom HUB AI"

-- Settings
local DEFAULT_API_COOLDOWN = 4.0
local MAX_CHARS = 200

-- Colors
local C_DARK = Color3.fromRGB(20, 20, 20)
local C_FRAME = Color3.fromRGB(30, 30, 30)
local C_ACCENT = Color3.fromRGB(138, 43, 226) -- Phantom Violet
local C_TEXT = Color3.fromRGB(240, 240, 240)
local C_SUBTEXT = Color3.fromRGB(150, 150, 150)
local C_RED = Color3.fromRGB(255, 65, 65)
local C_GREEN = Color3.fromRGB(65, 255, 100)
local C_BLUE = Color3.fromRGB(65, 150, 255)

local Config = {
	MaxDistance = 25,
	ApiCooldown = DEFAULT_API_COOLDOWN,
	ShowRange = false
}

local Settings = {
	Chat_Enabled = false,
	Auto_Walk = false,
	Auto_Talk = false
}

local BasePersona = "You are a Roblox Player. Keep responses under 200 characters."
local CurrentPersona = BasePersona
local PlayerCooldowns = {}
local IsThinking = false

-- UI Variables
local ScreenGui, MainFrame, ConsoleLabel, RangeCirclePart
local VisualLoop

-- // FLAT RANGE VISUALS \\ --

local function UpdateRangeCircle()
	-- 1. If turned off or no character, hide/destroy
	if not Config.ShowRange or not RootPart then
		if RangeCirclePart then 
			RangeCirclePart:Destroy()
			RangeCirclePart = nil
		end
		return
	end

	-- 2. Create if missing
	if not RangeCirclePart then
		RangeCirclePart = Instance.new("Part")
		RangeCirclePart.Name = "PhantomRangeVisual"
		RangeCirclePart.Anchored = true
		RangeCirclePart.CanCollide = false
		RangeCirclePart.CastShadow = false
		RangeCirclePart.Material = Enum.Material.ForceField -- Looks cool/futuristic
		RangeCirclePart.BrickColor = BrickColor.new("Royal purple")
		RangeCirclePart.Transparency = 0.8
		RangeCirclePart.Shape = Enum.PartType.Cylinder
		RangeCirclePart.Parent = Workspace
		
		-- Cleanup automatically
		RangeCirclePart.Destroying:Connect(function() RangeCirclePart = nil end)
	end

	-- 3. Position Logic (Raycast to find ground)
	local rayOrigin = RootPart.Position
	local rayDirection = Vector3.new(0, -50, 0) -- Look down
	local rayParams = RaycastParams.new()
	rayParams.FilterDescendantsInstances = {Character, RangeCirclePart}
	rayParams.FilterType = Enum.RaycastFilterType.Exclude

	local rayResult = Workspace:Raycast(rayOrigin, rayDirection, rayParams)
	local groundY = rayOrigin.Y - 2.8 -- Default fallback if in air
	
	if rayResult then
		groundY = rayResult.Position.Y
	end

	-- 4. Update Transform
	-- Note: Cylinder Part "Height" is X axis. "Diameter" is Y/Z.
	-- We rotate Z by 90 degrees so the "Height" (X) becomes vertical.
	
	RangeCirclePart.CFrame = CFrame.new(rayOrigin.X, groundY + 0.05, rayOrigin.Z) * CFrame.Angles(0, 0, math.rad(90))
	
	-- Size: X is thickness (flat), Y/Z is diameter (Range * 2)
	RangeCirclePart.Size = Vector3.new(0.05, Config.MaxDistance * 2, Config.MaxDistance * 2)
end

-- // SYSTEM FUNCTIONS \\ --

local function UpdateConsole(text)
	if ConsoleLabel then ConsoleLabel.Text = "> " .. text end
end

local function SendChatMessage(text)
	if not text or text:gsub("%s+", "") == "" then return end
	if #text > MAX_CHARS then text = string.sub(text, 1, MAX_CHARS) end
	
	if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
		local channels = TextChatService:FindFirstChild("TextChannels")
		if channels then
			local targetChannel = channels:FindFirstChild("RBXGeneral") or channels:FindFirstChild("General")
			if targetChannel then targetChannel:SendAsync(text) return end
		end
	end
	
	local events = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
	if events and events:FindFirstChild("SayMessageRequest") then
		events.SayMessageRequest:FireServer(text, "All")
	else
		game:GetService("Players"):Chat(text)
	end
end

local function DestroySystem()
	Settings.Chat_Enabled = false
	if ScreenGui then ScreenGui:Destroy() end
	if RangeCirclePart then RangeCirclePart:Destroy() end
	if VisualLoop then VisualLoop:Disconnect() end
end

LP.CharacterAdded:Connect(function(newChar)
	Character = newChar
	Humanoid = newChar:WaitForChild("Humanoid", 10)
	RootPart = newChar:WaitForChild("HumanoidRootPart", 10)
	UpdateConsole("Respawned")
end)

-- // UI CONSTRUCTION \\ --

ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "PhantomHub_AI"
ScreenGui.ResetOnSpawn = false
if CoreGui:FindFirstChild("PhantomHub_AI") then CoreGui.PhantomHub_AI:Destroy() end
ScreenGui.Parent = CoreGui

MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 250, 0, 450)
MainFrame.Position = UDim2.new(0.05, 0, 0.35, 0)
MainFrame.BackgroundColor3 = C_DARK
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.ClipsDescendants = true

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = C_ACCENT
MainStroke.Thickness = 2
MainStroke.Parent = MainFrame

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 8)
MainCorner.Parent = MainFrame

-- // DRAGGABLE LOGIC (Improved) \\ --
local dragging = false
local dragInput, dragStart, startPos

local function UpdateDrag(input)
	local delta = input.Position - dragStart
	MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

MainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = MainFrame.Position
		
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

MainFrame.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		UpdateDrag(input)
	end
end)

-- Title
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -30, 0, 35)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "PHANTOM HUB | AI"
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextSize = 16
TitleLabel.TextColor3 = C_ACCENT
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = MainFrame

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 30, 0, 30)
CloseBtn.Position = UDim2.new(1, -35, 0, 2)
CloseBtn.BackgroundTransparency = 1
CloseBtn.Text = "X"
CloseBtn.TextColor3 = C_RED
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 18
CloseBtn.Parent = MainFrame
CloseBtn.MouseButton1Click:Connect(DestroySystem)

-- Console
local ConsoleFrame = Instance.new("Frame")
ConsoleFrame.Size = UDim2.new(0.9, 0, 0, 25)
ConsoleFrame.Position = UDim2.new(0.05, 0, 0.09, 0)
ConsoleFrame.BackgroundColor3 = C_FRAME
ConsoleFrame.Parent = MainFrame
Instance.new("UICorner", ConsoleFrame).CornerRadius = UDim.new(0, 4)

ConsoleLabel = Instance.new("TextLabel")
ConsoleLabel.Size = UDim2.new(0.95, 0, 1, 0)
ConsoleLabel.Position = UDim2.new(0.05, 0, 0, 0)
ConsoleLabel.BackgroundTransparency = 1
ConsoleLabel.Text = "> System Ready"
ConsoleLabel.Font = Enum.Font.Code
ConsoleLabel.TextSize = 12
ConsoleLabel.TextColor3 = C_GREEN
ConsoleLabel.TextXAlignment = Enum.TextXAlignment.Left
ConsoleLabel.Parent = ConsoleFrame

-- Scrolling Container
local ControlsObj = Instance.new("ScrollingFrame")
ControlsObj.Size = UDim2.new(1, 0, 0.8, 0)
ControlsObj.Position = UDim2.new(0, 0, 0.16, 0)
ControlsObj.BackgroundTransparency = 1
ControlsObj.ScrollBarThickness = 3
ControlsObj.Parent = MainFrame
ControlsObj.AutomaticCanvasSize = Enum.AutomaticSize.Y
ControlsObj.CanvasSize = UDim2.new(0, 0, 0, 0)

local UIList = Instance.new("UIListLayout")
UIList.Parent = ControlsObj
UIList.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIList.Padding = UDim.new(0, 8)
UIList.SortOrder = Enum.SortOrder.LayoutOrder

local UIPad = Instance.new("UIPadding")
UIPad.Parent = ControlsObj
UIPad.PaddingTop = UDim.new(0, 5)
UIPad.PaddingBottom = UDim.new(0, 5)

-- UI Helper
local function CreateToggle(text, callback, default)
	local Frame = Instance.new("Frame")
	Frame.Size = UDim2.new(0.9, 0, 0, 30)
	Frame.BackgroundColor3 = C_FRAME
	Frame.Parent = ControlsObj
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
	
	local Lbl = Instance.new("TextLabel")
	Lbl.Size = UDim2.new(0.6, 0, 1, 0)
	Lbl.Position = UDim2.new(0.05, 0, 0, 0)
	Lbl.BackgroundTransparency = 1
	Lbl.Text = text
	Lbl.TextColor3 = C_TEXT
	Lbl.Font = Enum.Font.GothamSemibold
	Lbl.TextSize = 12
	Lbl.TextXAlignment = Enum.TextXAlignment.Left
	Lbl.Parent = Frame
	
	local Btn = Instance.new("TextButton")
	Btn.Size = UDim2.new(0, 40, 0, 20)
	Btn.Position = UDim2.new(0.8, 0, 0.15, 0)
	Btn.BackgroundColor3 = default and C_ACCENT or Color3.fromRGB(50,50,50)
	Btn.Text = default and "ON" or "OFF"
	Btn.TextColor3 = Color3.fromRGB(200,200,200)
	Btn.Font = Enum.Font.GothamBold
	Btn.TextSize = 10
	Btn.Parent = Frame
	Instance.new("UICorner", Btn).CornerRadius = UDim.new(1, 0)
	
	local isActive = default
	Btn.MouseButton1Click:Connect(function()
		isActive = not isActive
		Btn.Text = isActive and "ON" or "OFF"
		TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = isActive and C_ACCENT or Color3.fromRGB(50,50,50)}):Play()
		callback(isActive)
	end)
end

-- Toggles
CreateToggle("Enable Chat AI", function(v) Settings.Chat_Enabled = v end, false)
CreateToggle("Auto Walk", function(v) Settings.Auto_Walk = v end, false)
CreateToggle("Show Range ", function(v) 
	Config.ShowRange = v 
	UpdateRangeCircle()
end, false)

-- Divider
local Spacer1 = Instance.new("Frame")
Spacer1.Size = UDim2.new(1,0,0,5)
Spacer1.BackgroundTransparency = 1
Spacer1.Parent = ControlsObj

-- Personality Section
local PersonaLabel = Instance.new("TextLabel")
PersonaLabel.Text = "PERSONALITY MODE"
PersonaLabel.Size = UDim2.new(0.9,0,0,20)
PersonaLabel.BackgroundTransparency = 1
PersonaLabel.TextColor3 = C_SUBTEXT
PersonaLabel.Font = Enum.Font.GothamBold
PersonaLabel.TextSize = 10
PersonaLabel.Parent = ControlsObj

local function CreatePersonaBtn(text, color, prompt)
	local Btn = Instance.new("TextButton")
	Btn.Size = UDim2.new(0.9, 0, 0, 28)
	Btn.BackgroundColor3 = C_FRAME
	Btn.Text = text
	Btn.TextColor3 = color
	Btn.Font = Enum.Font.GothamBold
	Btn.TextSize = 12
	Btn.Parent = ControlsObj
	
	local Stroke = Instance.new("UIStroke")
	Stroke.Color = color
	Stroke.Thickness = 1
	Stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	Stroke.Parent = Btn
	Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
	
	Btn.MouseButton1Click:Connect(function()
		CurrentPersona = prompt .. " CRITICAL: REPLY MUST BE UNDER 200 CHARACTERS."
		UpdateConsole("Set: " .. text)
		
		-- Flash Effect
		local originalColor = Btn.BackgroundColor3
		TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = color, TextColor3 = C_DARK}):Play()
		task.wait(0.1)
		TweenService:Create(Btn, TweenInfo.new(0.3), {BackgroundColor3 = originalColor, TextColor3 = color}):Play()
	end)
end

CreatePersonaBtn("PLAYFUL ", C_GREEN, "You are a playful, energetic, and happy Roblox player. Use emojis. Keep responses very short.")
CreatePersonaBtn("ANGRY ", C_RED, "You are a furious, toxic, and aggressive Roblox player. USE CAPS. Keep responses very short.")
CreatePersonaBtn("SAD ", C_BLUE, "You are a depressed, sad, and gloomy Roblox player. Lowercase only. Keep responses very short.")
CreatePersonaBtn("SKIBIDI BRAINROT ", C_ACCENT, "You are a Gen Alpha brainrot player (skibidi, rizz, sigma, ohio). Keep responses very short.")

local Spacer2 = Instance.new("Frame")
Spacer2.Size = UDim2.new(1,0,0,5)
Spacer2.BackgroundTransparency = 1
Spacer2.Parent = ControlsObj

-- Inputs
local CustomInput = Instance.new("TextBox")
CustomInput.Size = UDim2.new(0.9, 0, 0, 30)
CustomInput.BackgroundColor3 = C_FRAME
CustomInput.PlaceholderText = "Custom Persona..."
CustomInput.Text = ""
CustomInput.TextColor3 = C_TEXT
CustomInput.Font = Enum.Font.Gotham
CustomInput.TextSize = 12
CustomInput.Parent = ControlsObj
Instance.new("UICorner", CustomInput).CornerRadius = UDim.new(0, 6)
CustomInput.FocusLost:Connect(function()
	if CustomInput.Text ~= "" then
		CurrentPersona = CustomInput.Text .. " (Max 200 chars)"
		UpdateConsole("Custom Set")
	end
end)

local RangeInput = Instance.new("TextBox")
RangeInput.Size = UDim2.new(0.9, 0, 0, 30)
RangeInput.BackgroundColor3 = C_FRAME
RangeInput.PlaceholderText = "Range (Default: 25)"
RangeInput.Text = ""
RangeInput.TextColor3 = C_TEXT
RangeInput.Font = Enum.Font.Gotham
RangeInput.TextSize = 12
RangeInput.Parent = ControlsObj
Instance.new("UICorner", RangeInput).CornerRadius = UDim.new(0, 6)
RangeInput.FocusLost:Connect(function()
	local n = tonumber(RangeInput.Text)
	if n then 
		Config.MaxDistance = n 
		UpdateConsole("Range: " .. n)
		UpdateRangeCircle()
	end
end)

-- // AI LOGIC \\ --

function GetVisuals()
	if not RootPart then return "Blind" end
	local items = {}
	local count = 0
	local maxItems = 5
	local range = Config.MaxDistance
	
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LP and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (RootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
			if dist <= range then
				table.insert(items, {d = dist, txt = "Player:"..plr.DisplayName})
				count = count + 1
			end
		end
	end
	
	local str = ""
	for _, i in ipairs(items) do str = str .. i.txt .. ", " end
	return str == "" and "Empty" or str
end

function ExecuteAI(prompt, systemContext)
	if IsThinking then return end
	IsThinking = true
	UpdateConsole("Thinking...")
	
	local messages = {
		{role = "system", content = CurrentPersona .. " [Surroundings: " .. systemContext .. "]"},
		{role = "user", content = prompt}
	}
	
	local success, response = pcall(function()
		return HttpRequest({
			Url = BASE_URL,
			Method = "POST",
			Headers = {
				["Content-Type"] = "application/json",
				["Authorization"] = "Bearer " .. API_KEY,
				["HTTP-Referer"] = SITE_URL,
				["X-Title"] = SITE_NAME
			},
			Body = HttpService:JSONEncode({
				model = AI_MODEL,
				messages = messages,
				max_tokens = 60
			})
		})
	end)
	
	IsThinking = false
	
	if success and response.StatusCode == 200 then
		local data = HttpService:JSONDecode(response.Body)
		if data.choices and data.choices[1] then
			local reply = data.choices[1].message.content
			UpdateConsole("Replied")
			return reply
		end
	else
		UpdateConsole("API Error")
	end
	return nil
end

function HandleAction(response)
	if not response then return end
	if Settings.Auto_Walk and (response:lower():find("walk") or math.random() > 0.7) then
		local x = math.random(-15, 15)
		local z = math.random(-15, 15)
		Humanoid:MoveTo(RootPart.Position + Vector3.new(x, 0, z))
	end
	SendChatMessage(response)
end

-- // LOOPS \\ --

VisualLoop = RunService.RenderStepped:Connect(UpdateRangeCircle)

local function ProcessChat(plr, msg)
	if not Settings.Chat_Enabled or plr == LP then return end
	local dist = (RootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
	if dist > Config.MaxDistance then return end
	
	local now = tick()
	if PlayerCooldowns[plr] and (now - PlayerCooldowns[plr] < DEFAULT_API_COOLDOWN) then return end
	PlayerCooldowns[plr] = now
	
	task.spawn(function()
		local visuals = GetVisuals()
		local reply = ExecuteAI(msg, visuals)
		HandleAction(reply)
	end)
end

if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
	TextChatService.MessageReceived:Connect(function(msg)
		if msg.TextSource then
			local plr = Players:GetPlayerByUserId(msg.TextSource.UserId)
			if plr and plr.Character then ProcessChat(plr, msg.Text) end
		end
	end)
else
	for _, p in pairs(Players:GetPlayers()) do
		p.Chatted:Connect(function(m) ProcessChat(p, m) end)
	end
	Players.PlayerAdded:Connect(function(p)
		p.Chatted:Connect(function(m) ProcessChat(p, m) end)
	end)
end

UpdateConsole("Phantom Loaded")
